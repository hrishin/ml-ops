name: Deploy serving service

concurrency: 
  group: deployment-pipeline
  cancel-in-progress: false

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'New image version to deploy (e.g. v1.2.0)'
        required: true

jobs:
  deploy-to-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    environment: development
    timeout-minutes: 0 # No timeout
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install yq
        uses: mikefarah/yq@v4.35.1

      - name: Update tag in destination file
        run: |
          SRC=deployment/overlays/dev/apps/values.yaml
          yq e '.spec.values.image.tag = "${{ github.event.inputs.version }}"' -i "$SRC"

      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "Deployed the version ${{ github.event.inputs.version }} to the dev environment"
          git push
    
      - name: Write summary
        run: |
          echo "### ðŸš€ Pushed Docker image tag ${VERSION} to the dev environment" >> $GITHUB_STEP_SUMMARY
        env:
          VERSION: ${{ github.event.inputs.version || 'latest' }}

  request-stage-approval:
    name: Request Stage Deployment Approval
    needs: deploy-to-dev
    runs-on: ubuntu-latest
    timeout-minutes: 0 # No timeout
    environment:
      name: stage-approval
      url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
    steps:
      - name: Approval notification
        run: echo "Deployment to staging environment requires approval"

  deploy-to-stage:
    name: Deploy to Stage
    runs-on: ubuntu-latest
    environment: stage
    timeout-minutes: 0 # No timeout
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install yq
        uses: mikefarah/yq@v4.35.1

      - name: Update tag in destination file
        run: |
          SRC=deployment/overlays/dev/stage/values.yaml
          yq e '.spec.values.image.tag = "${{ github.event.inputs.version }}"' -i "$SRC"

      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "Deployed the version ${{ github.event.inputs.version }} to the stage environment"
          git push
    
      - name: Write summary
        run: |
          echo "### ðŸš€ Pushed Docker image tag ${VERSION} to the stage environment" >> $GITHUB_STEP_SUMMARY
        env:
          VERSION: ${{ github.event.inputs.version || 'latest' }}

  request-prod-approval:
    name: Request Production Deployment Approval
    needs: deploy-to-stage
    runs-on: ubuntu-latest
    timeout-minutes: 0 # No timeout
    environment:
      name: prod-approval
      url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
    steps:
      - name: Approval notification
        run: echo "Deployment to production environment requires approval"

  deploy-to-prod:
    name: Deploy to Stage
    runs-on: ubuntu-latest
    environment: prod
    timeout-minutes: 0 # No timeout
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install yq
        uses: mikefarah/yq@v4.35.1

      - name: Update tag in destination file
        run: |
          SRC=deployment/overlays/dev/prod/values.yaml
          yq e '.spec.values.image.tag = "${{ github.event.inputs.version }}"' -i "$SRC"

      - name: Commit and push changes
        run: |
          git config user.name "GitHub Actions"
          git config user.email "github-actions@github.com"
          git add .
          git commit -m "Deployed the version ${{ github.event.inputs.version }} to the prod environment"
          git push
    
      - name: Write summary
        run: |
          echo "### ðŸš€ Pushed Docker image tag ${VERSION} to the prod environment" >> $GITHUB_STEP_SUMMARY
        env:
          VERSION: ${{ github.event.inputs.version || 'latest' }}
